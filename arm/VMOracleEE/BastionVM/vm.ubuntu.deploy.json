{
	"$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"location": {
			"type": "string",
			"metadata": {
				"displayName": "Azure region",
				"description": "The Azure region within which to deploy. Examples: 'East US', 'West US', and so on. See https://azure.microsoft.com/regions/."
			}
		},
		"availabilitySetName": {
			"type": "string",
			"metadata": {
				"displayName": "Availability set",
				"description": "A managed availability set to which to join the VM. If the availability set does not yet exist, it will be created."
			}
		},
		"resourceGroupNameVM": {
			"type": "string",
			"metadata": {
				"displayName": "Resource Group for VM",
				"description": "The resource group name that should contain the VM and its related resources, such as NIC and public IP."
			}
		},
		"virtualMachineName": {
			"type": "string",
			"metadata": {
				"displayName": "Virtual Machine name",
				"description": "The VM name. Should be unique within the resource group."
			}
		},
		"virtualMachineSize": {
			"type": "string",
			"metadata": {
				"displayName": "Virtual Machine size",
				"description": "The VM size. See https://docs.microsoft.com/azure/virtual-machines/windows/sizes or use Azure CLI command 'az vm list-sizes'."
			}
		},
		"publisher": {
			"type": "string",
			"metadata": {
				"displayName": "Publisher",
				"description": "CLI: az vm image list-publishers -l [Azure region]"
			}
		},
		"offer": {
			"type": "string",
			"metadata": {
				"displayName": "Offer",
				"description": "CLI: az vm image list-offers -l [Azure region] --publisher [Publisher]"
			}
		},
		"sku": {
			"type": "string",
			"metadata": {
				"displayName": "SKU",
				"description": "CLI: az vm image list-skus -l [Azure region] --publisher [Publisher] --offer [Offer]"
			}
		},
		"version": {
			"type": "string",
			"defaultValue": "latest",
			"metadata": {
				"displayName": "Version",
				"description": "Image version. Typically use latest."
			}
		},
		"adminUsername": {
			"type": "string",
			"metadata": {
				"displayName": "VM administrator username",
				"description": "VM administrator username"
			}
		},
		"adminPassword": {
			"type": "securestring",
			"metadata": {
				"displayName": "VM administrator password",
				"description": "VM administrator password"
			}
		},
		"sshKeyData": {
			"type": "securestring",
			"metadata": {
				"displayName": "SSH public key as a string",
				"description": "SSH public key as a string"
			}
		},
		"osDiskStorageType": {
			"type": "string",
			"allowedValues": [
				"Standard_LRS",
				"Premium_LRS"
			],
			"defaultValue": "Premium_LRS",
			"metadata": {
				"displayName": "OS disk storage type",
				"description": "OS disk storage type. Standard_LRS uses HDD storage, Premium_LRS uses SSD storage"
			}
		},
		"osDiskSizeInGB": {
			"type": "int",
			"defaultValue": 129,
			"minValue": 32,
			"maxValue": 1023,
			"metadata": {
				"displayName": "OS disk size",
				"description": "OS disk size in GB"
			}
		},
		"publicIpAddressType": {
			"type": "string",
			"allowedValues": [
				"Dynamic",
				"Static"
			],
			"defaultValue": "Dynamic",
			"metadata": {
				"displayName": "Public IP address type",
				"description": "The public IP address type: Static or Dynamic."
			}
		},
		"publicIpAddressSku": {
			"type": "string",
			"allowedValues": [
				"Basic",
				"Standard"
			],
			"defaultValue": "Basic",
			"metadata": {
				"displayName": "Public IP address SKU",
				"description": "The public IP address SKU to use. See https://docs.microsoft.com/azure/virtual-network/virtual-network-ip-addresses-overview-arm"
			}
		},
		"resourceGroupNameNetwork": {
			"type": "string",
			"metadata": {
				"displayName": "Resource Group for networking resources",
				"description": "The Resource Group that contains the VNet, subnet, and NSG to use. Can be the same as the Resource Group where the VM will be deployed, or can refer to a separate Resource Group which contains durable networking resources."
			}
		},
		"virtualNetworkName": {
			"type": "string",
			"metadata": {
				"displayName": "VNet",
				"description": "Virtual network into which to deploy the VM"
			}
		},
		"subnetName": {
			"type": "string",
			"metadata": {
				"displayName": "Subnet",
				"description": "Subnet into which to deploy the VM"
			}
		},
		"storageShellCommand": {
			"type": "string",
			"metadata": {
				"displayName": "Storage shell command",
				"description": "Storage shell command to mount external storage"
			}
		}
	},
	"variables": {
		"vnetId": "[resourceId(parameters('resourceGroupNameNetwork'), 'Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
		"subnetReference": "[concat(variables('vnetId'), '/subnets/', parameters('subnetName'))]",
		"uniqueDnsLabelPrefix": "[concat(parameters('virtualMachineName'), uniquestring(resourceGroup().id))]",
		"osDiskName": "[concat(parameters('virtualMachineName'), '_os')]",
		"networkInterfaceName": "[concat(parameters('virtualMachineName'), '_nic')]",
		"publicIpAddressName": "[concat(parameters('virtualMachineName'), '_pip')]",
		"computeApiVersion": "2018-06-01",
		"networkApiVersion": "2018-08-01"
	},
	"resources": [
		{
			"type": "Microsoft.Compute/availabilitySets",
			"sku": {
				"name": "Aligned"
			},
			"name": "[parameters('availabilitySetName')]",
			"apiVersion": "[variables('computeApiVersion')]",
			"location": "[parameters('location')]",
			"properties": {
				"platformUpdateDomainCount": 5,
				"platformFaultDomainCount": 3,
				"virtualMachines": []
			},
			"dependsOn": []
		},
		{
			"name": "[parameters('virtualMachineName')]",
			"type": "Microsoft.Compute/virtualMachines",
			"apiVersion": "[variables('computeApiVersion')]",
			"location": "[parameters('location')]",
			"dependsOn": [
				"[concat('Microsoft.Network/networkInterfaces/', variables('networkInterfaceName'))]"
			],
			"properties": {
				"availabilitySet": {
					"id": "[resourceId('Microsoft.Compute/availabilitySets', parameters('availabilitySetName'))]"
				},
				"osProfile": {
					"computerName": "[parameters('virtualMachineName')]",
					"adminUsername": "[parameters('adminUsername')]",
					"adminPassword": "[parameters('adminPassword')]",
					"linuxConfiguration": {
						"provisionVMAgent": "true",
						"disablePasswordAuthentication": false,
						"ssh": {
							"publicKeys": [
								{
									"path": "[concat('/home/', parameters('adminUsername'), '/.ssh/authorized_keys')]",
									"keyData": "[parameters('sshKeyData')]"
								}
							]
						}
					}
				},
				"hardwareProfile": {
					"vmSize": "[parameters('virtualMachineSize')]"
				},
				"storageProfile": {
					"imageReference": {
						"publisher": "[parameters('publisher')]",
						"offer": "[parameters('offer')]",
						"sku": "[parameters('sku')]",
						"version": "[parameters('version')]"
					},
					"osDisk": {
						"createOption": "FromImage",
						"name": "[variables('osDiskName')]",
						"diskSizeGB": "[parameters('osDiskSizeInGB')]",
						"managedDisk": {
							"storageAccountType": "[parameters('osDiskStorageType')]"
						}
					}
				},
				"networkProfile": {
					"networkInterfaces": [
						{
							"id": "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaceName'))]"
						}
					]
				}
			},
			"resources": []
		},
		{
			"name": "[variables('networkInterfaceName')]",
			"type": "Microsoft.Network/networkInterfaces",
			"apiVersion": "[variables('networkApiVersion')]",
			"location": "[parameters('location')]",
			"dependsOn": [
				"[concat('Microsoft.Network/publicIpAddresses/', variables('publicIpAddressName'))]"
			],
			"properties": {
				"enableAcceleratedNetworking": true,
				"ipConfigurations": [
					{
						"name": "ipconfig1",
						"properties": {
							"subnet": {
								"id": "[variables('subnetReference')]"
							},
							"privateIPAllocationMethod": "Dynamic",
							"publicIpAddress": {
								"id": "[resourceId(parameters('resourceGroupNameVM'), 'Microsoft.Network/publicIpAddresses', variables('publicIpAddressName'))]"
							}
						}
					}
				]
			}
		},
		{
			"name": "[variables('publicIpAddressName')]",
			"type": "Microsoft.Network/publicIpAddresses",
			"apiVersion": "[variables('networkApiVersion')]",
			"location": "[parameters('location')]",
			"properties": {
				"publicIpAllocationMethod": "[parameters('publicIpAddressType')]",
				"dnsSettings": {
					"domainNameLabel": "[variables('uniqueDnsLabelPrefix')]"
				}
			},
			"sku": {
				"name": "[parameters('publicIpAddressSku')]"
			}
		},
		{
			"name": "[concat(parameters('virtualMachineName'),'/','extensions')]",
			"type": "Microsoft.Compute/virtualMachines/extensions",
			"location": "[parameters('location')]",
			"apiVersion": "[variables('computeApiVersion')]",
			"dependsOn": [
				"[concat('Microsoft.Compute/virtualMachines/', parameters('virtualMachineName'))]"
			],
			"properties": {
				"publisher": "Microsoft.Azure.Extensions",
				"type": "CustomScript",
				"typeHandlerVersion": "2.0",
				"autoUpgradeMinorVersion": true,
				"settings": {
					"commandToExecute": "[parameters('storageShellCommand')]"
				}
			}
		}
	],
	"outputs": {
		"vmName": {
			"type": "string",
			"value": "[parameters('virtualMachineName')]"
		},
		"publicFqdn": {
			"type": "string",
			"value": "[reference(variables('publicIpAddressName')).dnsSettings.fqdn]"
		},
		"privateIpAddress": {
			"type": "string",
			"value": "[reference(variables('networkInterfaceName')).ipConfigurations[0].properties.privateIPAddress]"
		},
		"internalDomainNameSuffix": {
			"type": "string",
			"value": "[reference(variables('networkInterfaceName')).dnsSettings.internalDomainNameSuffix]"
		},
		"appliedDnsServers": {
			"type": "array",
			"value": "[reference(variables('networkInterfaceName')).dnsSettings.appliedDnsServers]"
		},
		"dnsServers": {
			"type": "array",
			"value": "[reference(variables('networkInterfaceName')).dnsSettings.dnsServers]"
		}
	}
}